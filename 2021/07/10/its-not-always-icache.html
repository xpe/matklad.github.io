<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>It&#8217;s Not Always ICache</title>
  <meta name="description"
    content="This is a follow up to the previous post about #[inline] in Rust specifically.This post is a bit more general, and a bit more ranty.Reader, beware!">
  <link rel="canonical" href="https://matklad.github.io//2021/07/10/its-not-always-icache.html">
  <link rel="alternate" type="application/rss+xml" title="matklad" href="https://matklad.github.io//feed.xml">

  <style>
    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Bold.woff2') format('woff2');
      ;
      font-weight: bold;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      margin-block-start: 0;
      margin-block-end: 0;
    }

    h1,
    h2,
    h3 {
      font-weight: 300;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    main {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 80ch;
      padding-left: 2ch;
      padding-right: 2ch;
    }

    .site-header {
      width: 100%;
      max-width: 80ch;
      margin-bottom: 1.5rem;
    }

    .site-header>nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
    }

    .site-header .-title {
      flex-grow: 2;
    }

    .site-footer {
      display: flex;
      justify-content: center;
      align-items: baseline;
      width: 100%;
      max-width: 80ch;
      margin-top: 1rem;
      height: 2rem;
      padding-left: 1ch;
      padding-right: 1ch;
    }
  </style>
  <link rel="stylesheet" href=" /css/adoc.css">
  <link rel="stylesheet" href=" /css/rouge-github.css">
  <link rel="stylesheet" href=" /css/main.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=EB+Garamond:400,400italic,700,700italic%7COpen+Sans:300">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>
  <header class="site-header">
    <nav>
      <a class="-title" href="/">matklad</a>
      
      
      <a href="/about/">About</a>
      
      
      
      
      
      <a href="/resume/">Resume</a>
      
      
      
      
      
      
      
      
      
      
    </nav>
  </header>

  <main>
    <article>
  <h1>It&#8217;s Not Always ICache</h1>
  <div class="post-meta sect1">Jul 10, 2021</div>
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is a follow up to the <a href="https://matklad.github.io/2021/07/09/inline-in-rust.html">previous post</a> about <code>#[inline]</code> in Rust specifically.
This post is a bit more general, and a bit more ranty.
Reader, beware!</p>
</div>
<div class="paragraph">
<p>When inlining optimization is discussed, the following is almost always mentioned: &#8220;inlining can also make code slower, <em>because</em> inlining increases the code size, blowing the instruction cache size and causing cache misses&#8221;.</p>
</div>
<div class="paragraph">
<p>I myself have seen this repeated on various forms many times.
I have also seen a lot of benchmarks where judicious removal of inlining annotations did increase performance.
However, not once have I seen the performance improvement being traced to ICache specifically.
To me at least, this explanation doesn&#8217;t seem to be grounded&#8201;&#8212;&#8201;people know that ICache is to blame because other people say this, not because there&#8217;s a benchmark everyone points to.
It doesn&#8217;t mean that the ICache explanation is wrong&#8201;&#8212;&#8201;just that I personally don&#8217;t have evidence to believe it is better than any other explanation.</p>
</div>
<div class="paragraph">
<p>Anyway, I&#8217;ve decided to look at a specific case where I know <code>#[inline]</code> to cause an observable slow down, and understand why it happens.
Note that the goal here is not to explain real-world impact of <code>#[inline]</code>, the benchmark is artificial.
The goal is, first and foremost, to learn more about the tools to use for explaining results.
The secondary goal is to either observe ICache effects in practice, or else to provide an alternative hypothesis for why removing inlining can speed the things up.</p>
</div>
<div class="paragraph">
<p>The benchmark is based on my <a href="https://github.com/matklad/once_cell">once_cell</a> Rust library.
The library provides a primitive, similar to <a href="https://en.wikipedia.org/wiki/Double-checked_locking">double-checked locking</a>.
There&#8217;s a function that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="k">fn</span> <span class="n">get_or_try_init</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">F</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;&amp;</span><span class="n">T</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
 <span class="n">F</span><span class="p">:</span> <span class="nf">FnOnce</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.get</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Fast path.</span>
    <span class="k">return</span> <span class="nf">Ok</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c">// Slow path.</span>
  <span class="k">self</span><span class="na">.0</span><span class="nf">.initialize</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
  <span class="nf">Ok</span><span class="p">(</span><span class="k">unsafe</span> <span class="p">{</span> <span class="k">self</span><span class="nf">.get_unchecked</span><span class="p">()</span> <span class="p">})</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I know that performance improves significantly when the <code>initialize</code> function is not inlined.
It&#8217;s somewhat obvious that this is the case (that&#8217;s why the benchmark is synthetic&#8201;&#8212;&#8201;real world examples are about cases where we don&#8217;t know if <code>inline</code> is needed).
But it is unclear why, <em>exactly</em>, inlining <code>initialize</code> leads to slower code.</p>
</div>
<div class="paragraph">
<p>For the experiment, I wrote a simple high-level benchmark calling <code>get_or_try_init</code> in a loop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="k">const</span> <span class="n">N_LOOPS</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">static</span> <span class="n">CELL</span><span class="p">:</span> <span class="n">OnceCell</span><span class="o">&lt;</span><span class="nb">usize</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">OnceCell</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="n">N_LOOPS</span> <span class="p">{</span>
    <span class="nf">go</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">go</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="mi">_</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="mi">100_000_000</span> <span class="p">{</span>
    <span class="k">let</span> <span class="o">&amp;</span><span class="n">value</span> <span class="o">=</span> <span class="n">CELL</span><span class="nf">.get_or_init</span><span class="p">(||</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">assert</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">N_LOOPS</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I also added compile-time toggle to force or forbid inlining:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nd">#[cfg_attr(feature</span> <span class="nd">=</span> <span class="s">"inline_always"</span><span class="nd">,</span> <span class="nd">inline(always))]</span>
<span class="nd">#[cfg_attr(feature</span> <span class="nd">=</span> <span class="s">"inline_never"</span><span class="nd">,</span> <span class="nd">inline(never))]</span>
<span class="k">fn</span> <span class="nf">initialize</span><span class="p">()</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see the full benchmark in this commit: <a href="https://github.com/matklad/once_cell/commit/a741d5f2ca7cd89125ef1c70ee2e5fe660271050">matklad/once_cell@a741d5f</a>.</p>
</div>
<div class="paragraph">
<p>Running both versions shows that <code>#[inline(never)]</code> is indeed measurably faster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="gp">$</span><span class="w"> </span>cargo run <span class="nt">-q</span> <span class="nt">--example</span> bench  <span class="nt">--release</span> <span class="nt">--features</span> inline_always
<span class="go">330ms

</span><span class="gp">$</span><span class="w"> </span>cargo run <span class="nt">-q</span> <span class="nt">--example</span> bench  <span class="nt">--release</span> <span class="nt">--features</span> inline_never
<span class="go">259ms</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that we don&#8217;t use fancy statistics here.
<code>/usr/bin/time</code> is enough to see the difference with a naked eye despite the fact that the effect we are looking for is very low-level.
Hence, a general tip: if you are benchmarking relative difference (and not the absolute performance), don&#8217;t bother with measuring nanosecond-precision time.
Instead, loop the benchmark enough to make the change human-perceptible.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>How do we explain the difference?
The first step is to remove cargo from the equation and make two binaries for comparison:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="gp">$</span><span class="w"> </span>cargo build <span class="nt">--example</span> bench <span class="nt">--release</span> <span class="nt">--features</span> inline_never
<span class="gp">$</span><span class="w"> </span><span class="nb">cp</span> ./target/release/examples/bench never
<span class="gp">$</span><span class="w"> </span>cargo build <span class="nt">--example</span> bench <span class="nt">--release</span> <span class="nt">--features</span> inline_always
<span class="gp">$</span><span class="w"> </span><span class="nb">cp</span> ./target/release/examples/bench always
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>On Linux, the best tool to quickly access the performance of any program is <code>perf stat</code>.
It runs the program and shows a bunch of CPU-level performance counters, which might explain what&#8217;s going on.
As we suspect that ICache might be to blame, let&#8217;s include the counters for caches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="gp">$</span><span class="w"> </span>perf <span class="nb">stat</span> <span class="nt">-e</span> instructions,cycles,<span class="se">\</span>
  L1-dcache-loads,L1-dcache-load-misses,L1-dcache-prefetches,<span class="se">\</span>
  L1-icache-loads,L1-icache-load-misses,cache-misses <span class="se">\</span>
  ./always
<span class="go">348ms

 6,396,754,995      instructions:u
 1,601,314,994      cycles:u
 1,600,621,170      L1-dcache-loads:u
         4,806      L1-dcache-load-misses:u
         4,402      L1-dcache-prefetches:u
        69,594      L1-icache-loads:u
           461      L1-icache-load-misses:u
         1,928      cache-misses:u

</span><span class="gp">$</span><span class="w"> </span>perf <span class="nb">stat</span> <span class="nt">-e</span> instructions,cycles,<span class="se">\</span>
  L1-dcache-loads,L1-dcache-load-misses,L1-dcache-prefetches,<span class="se">\</span>
  L1-icache-loads,L1-icache-load-misses,cache-misses <span class="se">\</span>
  ./never
<span class="go">261ms

 Performance counter stats for './never':

 5,597,215,493      instructions:u
 1,199,960,402      cycles:u
 1,599,404,303      L1-dcache-loads:u
         4,612      L1-dcache-load-misses:u
         4,290      L1-dcache-prefetches:u
        62,268      L1-icache-loads:u
           603      L1-icache-load-misses:u
         1,675      cache-misses:u</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is some difference in <code>L1-icache-load-misses</code>, but there&#8217;s also a surprising difference in <code>instructions</code>.
What&#8217;s more, the <code>L1-icache-load-misses</code> difference is hard to estimate, because it&#8217;s unclear what <code>L1-icache-loads</code> are.
As a sanity check, statistics for <code>dcache</code> are the same, just as we expect.</p>
</div>
<div class="paragraph">
<p>While <code>perf</code> takes the real data from the CPU, an alternative approach is to run the program in a simulated environment.
That&#8217;s what <code>cachegrind</code> tool does.
Fun fact: the primary author of cachegrind is <a href="https://github.com/nnethercote">@nnethercote</a>, whose <a href="https://nnethercote.github.io/perf-book/">Rust Performance Book</a> we saw in the last post.
Let&#8217;s see what <code>cachegrind</code> thinks about the benchmark.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="gp">$</span><span class="w"> </span>valgrind <span class="nt">--tool</span><span class="o">=</span>cachegrind ./always
<span class="go">10s
 I   refs:      6,400,577,147
 I1  misses:            1,560
 LLi misses:            1,524
 I1  miss rate:          0.00%
 LLi miss rate:          0.00%

 D   refs:      1,600,196,336
 D1  misses:            5,549
 LLd misses:            4,024
 D1  miss rate:           0.0%
 LLd miss rate:           0.0%

 LL refs:               7,109
 LL misses:             5,548
 LL miss rate:            0.0%

</span><span class="gp">$</span><span class="w"> </span>valgrind <span class="nt">--tool</span><span class="o">=</span>cachegrind ./never
<span class="go">9s
 I   refs:      5,600,577,226
 I1  misses:            1,572
 LLi misses:            1,529
 I1  miss rate:          0.00%
 LLi miss rate:          0.00%

 D   refs:      1,600,196,330
 D1  misses:            5,553
 LLd misses:            4,024
 D1  miss rate:           0.0%
 LLd miss rate:           0.0%

 LL refs:               7,125
 LL misses:             5,553
 LL miss rate:            0.0%</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that, because <code>cachegrind</code> simulates the program, it runs much slower.
Here, we don&#8217;t see a big difference in ICache misses (I1&#8201;&#8212;&#8201;first level instruction cache, LLi&#8201;&#8212;&#8201;last level instruction cache).
We do see a difference in ICache references.
Note that the number of times CPU refers to ICache should correspond to the number of instructions it executes.
Cross-checking the number with <code>perf</code>, we see that both <code>perf</code> and <code>cachegrind</code> agree on the number of instructions executed.
They also agree that <code>inline_always</code> version executes more instructions.
It&#8217;s still hard to say what perf&#8217;s <code>sL1-icache-loads</code> means.
Judging by the name, it should correspond to <code>cachegrind</code>'s <code>I refs</code>, but it doesn&#8217;t.</p>
</div>
<div class="paragraph">
<p>Anyway, it seems there&#8217;s one thing that bears further investigation&#8201;&#8212;&#8201;why inlining changes the number of instructions executed?
Inlining doesn&#8217;t actually change the code the CPU runs, so the number of instructions should stay the same.
Let&#8217;s look at the asm then!
The right tool here is <a href="https://github.com/gnzlbg/cargo-asm">cargo-asm</a>.</p>
</div>
<div class="paragraph">
<p>Again, here&#8217;s the function we will be locking at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">fn</span> <span class="nf">go</span><span class="p">(</span><span class="n">tid</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="mi">_</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="mi">100_000_000</span> <span class="p">{</span>
    <span class="k">let</span> <span class="o">&amp;</span><span class="n">value</span> <span class="o">=</span> <span class="n">CELL</span><span class="nf">.get_or_init</span><span class="p">(||</span> <span class="n">tid</span><span class="p">);</span>
    <span class="k">assert</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">N_THREADS</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The call to <code>get_or_init</code> will be inlined, and the nested call to <code>initialize</code> will be inlined depending on the flag.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first look at the <code>inline_never</code> version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="nasm"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre>  <span class="nf">push</span>    <span class="nv">r14</span> <span class="c1">;</span>
  <span class="nf">push</span>    <span class="nb">rbx</span> <span class="c1">; prologue</span>
  <span class="nf">push</span>    <span class="nb">rax</span> <span class="c1">;</span>
  <span class="nf">mov</span>     <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nb">rsp</span><span class="p">],</span> <span class="nb">rdi</span>
  <span class="nf">mov</span>     <span class="nb">ebx</span><span class="p">,</span> <span class="mi">100000001</span> <span class="c1">; loop counter</span>
  <span class="nf">mov</span>     <span class="nv">r14</span><span class="p">,</span> <span class="nb">rsp</span>
  <span class="nf">jmp</span>     <span class="nv">.LBB14_1</span>
 <span class="nl">.loop:</span>
<span class="hll">  <span class="nf">cmp</span>     <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="o">+</span><span class="mi">16</span><span class="p">],</span> <span class="mi">8</span>
</span><span class="hll">  <span class="nf">jae</span>     <span class="nv">.assert_failure</span>
</span><span class="hll"> <span class="nl">.LBB14_1:</span>
</span><span class="hll">  <span class="nf">add</span>     <span class="nb">rbx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span class="hll">  <span class="nf">je</span>      <span class="nv">.normal_exit</span>
</span><span class="hll">  <span class="nf">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="p">]</span>
</span><span class="hll">  <span class="nf">cmp</span>     <span class="nb">rax</span><span class="p">,</span> <span class="mi">2</span>
</span><span class="hll">  <span class="nf">je</span>      <span class="nv">.loop</span>
</span>  <span class="nf">mov</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="nv">r14</span>
  <span class="nf">call</span>    <span class="nv">once_cell</span><span class="p">::</span><span class="nv">imp</span><span class="p">::</span><span class="nv">OnceCell</span><span class="o">&lt;</span><span class="nv">T</span><span class="o">&gt;</span><span class="p">::</span><span class="nv">initialize</span>
  <span class="nf">jmp</span>     <span class="nv">.loop</span>
 <span class="nl">.normal_exit:</span>
  <span class="nf">add</span>     <span class="nb">rsp</span><span class="p">,</span> <span class="mi">8</span> <span class="c1">;</span>
  <span class="nf">pop</span>     <span class="nb">rbx</span>    <span class="c1">; epilogue</span>
  <span class="nf">pop</span>     <span class="nv">r14a</span>   <span class="c1">;</span>
  <span class="nf">ret</span>            <span class="c1">;</span>
 <span class="nl">.assert_failure:</span>
  <span class="nf">lea</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">.L__unnamed_12</span><span class="p">]</span>
  <span class="nf">lea</span>     <span class="nb">rdx</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">.L__unnamed_13</span><span class="p">]</span>
  <span class="nf">mov</span>     <span class="nb">esi</span><span class="p">,</span> <span class="mi">35</span>
  <span class="nf">call</span>    <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">core</span><span class="p">::</span><span class="nv">panicking</span><span class="p">::</span><span class="nv">panic@GOTPCREL</span><span class="p">]</span>
  <span class="nf">ud2</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then at the <code>inline_always</code> version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="nasm"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td><td class="code"><pre>  <span class="nf">push</span>    <span class="nb">rbp</span>  <span class="c1">;</span>
  <span class="nf">push</span>    <span class="nv">r15</span>  <span class="c1">;</span>
  <span class="nf">push</span>    <span class="nv">r14</span>  <span class="c1">;</span>
  <span class="nf">push</span>    <span class="nv">r13</span>  <span class="c1">; prologue</span>
  <span class="nf">push</span>    <span class="nv">r12</span>  <span class="c1">;</span>
  <span class="nf">push</span>    <span class="nb">rbx</span>  <span class="c1">;</span>
  <span class="nf">sub</span>     <span class="nb">rsp</span><span class="p">,</span> <span class="mi">24</span>
  <span class="nf">mov</span>     <span class="nv">r12</span><span class="p">,</span> <span class="nb">rdi</span>
  <span class="nf">xor</span>     <span class="nb">ebx</span><span class="p">,</span> <span class="nb">ebx</span>
  <span class="nf">mov</span>     <span class="nb">r13d</span><span class="p">,</span> <span class="mi">1</span>
  <span class="nf">lea</span>     <span class="nv">r14</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="p">]</span>
  <span class="nf">mov</span>     <span class="nb">rbp</span><span class="p">,</span> <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">WaiterQueue</span><span class="p">::</span><span class="nv">drop@GOTPCREL</span><span class="p">]</span>
  <span class="nf">mov</span>     <span class="nv">r15</span><span class="p">,</span> <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">once_cell</span><span class="p">::</span><span class="nv">imp</span><span class="p">::</span><span class="nv">wait@GOTPCREL</span><span class="p">]</span>
  <span class="nf">jmp</span>     <span class="nv">.LBB10_1</span>
 <span class="nl">.LBB10_10:</span>
  <span class="nf">mov</span>     <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nb">rsp</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="nv">r14</span>
  <span class="nf">mov</span>     <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span> <span class="mi">1</span>
  <span class="nf">mov</span>     <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="o">+</span><span class="mi">16</span><span class="p">],</span> <span class="nv">r12</span>
  <span class="nf">mov</span>     <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nb">rsp</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> <span class="mi">2</span>
  <span class="nf">lea</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="p">[</span><span class="nb">rsp</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
  <span class="nf">call</span>    <span class="nb">rbp</span>
 <span class="nl">.loop:</span>
<span class="hll">  <span class="nf">add</span>     <span class="nb">rbx</span><span class="p">,</span> <span class="mi">1</span>
</span><span class="hll">  <span class="nf">cmp</span>     <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="o">+</span><span class="mi">16</span><span class="p">],</span> <span class="mi">8</span>
</span><span class="hll">  <span class="nf">jae</span>     <span class="nv">.assert_failure</span>
</span><span class="hll"> <span class="nl">.LBB10_1:</span>
</span><span class="hll">  <span class="nf">cmp</span>     <span class="nb">rbx</span><span class="p">,</span> <span class="mi">100000000</span>
</span><span class="hll">  <span class="nf">je</span>      <span class="nv">.normal_exit</span>
</span><span class="hll">  <span class="nf">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="p">]</span>
</span><span class="hll">  <span class="nf">cmp</span>     <span class="nb">rax</span><span class="p">,</span> <span class="mi">2</span>
</span><span class="hll">  <span class="nf">je</span>      <span class="nv">.loop</span>
</span> <span class="nl">.LBB10_3:</span>
  <span class="nf">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="p">]</span>
 <span class="nl">.LBB10_4:</span>
  <span class="nf">test</span>    <span class="nb">rax</span><span class="p">,</span> <span class="nb">rax</span>
  <span class="nf">jne</span>     <span class="nv">.LBB10_5</span>
  <span class="nf">xor</span>     <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
  <span class="nf">lock</span>    <span class="nv">cmpxchg</span><span class="p">,</span> <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">CELL</span><span class="p">],</span> <span class="nv">r13</span>
  <span class="nf">jne</span>     <span class="nv">.LBB10_4</span>
  <span class="nf">jmp</span>     <span class="nv">.LBB10_10</span>
 <span class="nl">.LBB10_5:</span>
  <span class="nf">cmp</span>     <span class="nb">rax</span><span class="p">,</span> <span class="mi">2</span>
  <span class="nf">je</span>      <span class="nv">.loop</span>
  <span class="nf">mov</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="nb">eax</span>
  <span class="nf">and</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="mi">3</span>
  <span class="nf">cmp</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="mi">1</span>
  <span class="nf">jne</span>     <span class="nv">.LBB10_8</span>
  <span class="nf">mov</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="nv">r14</span>
  <span class="nf">mov</span>     <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rax</span>
  <span class="nf">call</span>    <span class="nv">r15</span>
  <span class="nf">jmp</span>     <span class="nv">.LBB10_3</span>
 <span class="nl">.normal_exit:</span>
  <span class="nf">add</span>     <span class="nb">rsp</span><span class="p">,</span> <span class="mi">24</span> <span class="c1">;</span>
  <span class="nf">pop</span>     <span class="nb">rbx</span>     <span class="c1">;</span>
  <span class="nf">pop</span>     <span class="nv">r12</span>     <span class="c1">;</span>
  <span class="nf">pop</span>     <span class="nv">r13</span>     <span class="c1">; epilogue</span>
  <span class="nf">pop</span>     <span class="nv">r14</span>     <span class="c1">;</span>
  <span class="nf">pop</span>     <span class="nv">r15</span>     <span class="c1">;</span>
  <span class="nf">pop</span>     <span class="nb">rbp</span>     <span class="c1">;</span>
  <span class="nf">ret</span>
 <span class="nl">.assert_failure:</span>
  <span class="nf">lea</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">.L__unnamed_9</span><span class="p">]</span>
  <span class="nf">lea</span>     <span class="nb">rdx</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">.L__unnamed_10</span><span class="p">]</span>
  <span class="nf">mov</span>     <span class="nb">esi</span><span class="p">,</span> <span class="mi">35</span>
  <span class="nf">call</span>    <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">core</span><span class="p">::</span><span class="nv">panicking</span><span class="p">::</span><span class="nv">panic@GOTPCREL</span><span class="p">]</span>
  <span class="nf">ud2</span>
 <span class="nl">.LBB10_8:</span>
  <span class="nf">lea</span>     <span class="nb">rdi</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">.L__unnamed_11</span><span class="p">]</span>
  <span class="nf">lea</span>     <span class="nb">rdx</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">.L__unnamed_12</span><span class="p">]</span>
  <span class="nf">mov</span>     <span class="nb">esi</span><span class="p">,</span> <span class="mi">57</span>
  <span class="nf">call</span>    <span class="kt">qword</span><span class="p">,</span> <span class="nv">ptr</span><span class="p">,</span> <span class="p">[</span><span class="nv">rip</span><span class="p">,</span> <span class="o">+</span><span class="p">,</span> <span class="nv">core</span><span class="p">::</span><span class="nv">panicking</span><span class="p">::</span><span class="nv">panic@GOTPCREL</span><span class="p">]</span>
  <span class="nf">ud2</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve slightly edited the code and also highlighted the hot loop which constitutes the bulk of the benchmark.</p>
</div>
<div class="paragraph">
<p>Looking at the assembly, we can see the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>code is much larger&#8201;&#8212;&#8201;inlining happened!</p>
</li>
<li>
<p>function prologue is bigger, compiler pushes more callee-saved registers to the stack</p>
</li>
<li>
<p>function epilogue is bigger, compiler needs to restore more registers</p>
</li>
<li>
<p>stack frame is larger</p>
</li>
<li>
<p>compiler hoisted some of the <code>initialize</code> code to before the loop</p>
</li>
<li>
<p>the core loop is very tight in both cases, just a handful of instructions</p>
</li>
<li>
<p>the core loop counts upwards rather than downwards, adding an extra <code>cmp</code> instruction</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that it&#8217;s highly unlikely that ICache affects the running code, as it&#8217;s a small bunch of instructions next to each other in memory.
On the other hand, an extra <code>cmp</code> with a large immediate precisely accounts for the amount of extra instructions we observe (the loop is run 800_000_000 times).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusions"><a class="anchor" href="#conclusions"></a>Conclusions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s hard enough to come up with a benchmark which demonstrate the difference between two alternatives.
It&#8217;s even harder to explain the difference&#8201;&#8212;&#8201;there might be many <a href="https://en.wikipedia.org/wiki/Availability_heuristic">readily available</a> explanations, but they are not necessary true.
Nonetheless, today we have a wealth of helpful tooling.
Two notable examples are <a href="https://perf.wiki.kernel.org/index.php/Tutorial">perf</a> and <a href="https://valgrind.org/docs/manual/quick-start.html">valgrind</a>.
Tools are not always correct&#8201;&#8212;&#8201;it&#8217;s a good idea to sanity check different tools against each other and against common-sense understanding of the problem.</p>
</div>
<div class="paragraph">
<p>For inlining in particular, we found the following reasons why inlining <code>S</code> into <code>C</code> might cause a slow down:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inlining might cause <code>C</code> to use more registers.
This means that prologue and epilogue grow additional push/pop instructions, which also use stack memory.
Without inlining, these instructions are hidden in <code>S</code> and are only paid for when <code>C</code> actually calls into <code>S</code>, as opposed to every time <code>C</code> itself is called.</p>
</li>
<li>
<p>Generalizing from the first point, if <code>S</code> is called in a loop or in an <code>if</code>, the compiler might hoist some instructions of <code>S</code> to before the branch, moving them from the cold path to the hot path.</p>
</li>
<li>
<p>With more local variables and control flow in the stack frame to juggle, compiler might accidentally pessimize the hot loop.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are curious under which conditions ICache does become an issue, there&#8217;s <a href="https://www.scylladb.com/2017/07/06/scyllas-approach-improve-performance-cpu-bound-workloads/">this excellent article</a> about one such case.</p>
</div>
</div>
</div>
</article>

  </main>

  <footer class="site-footer">
    <p>
      <a href="https://github.com/matklad/matklad.github.io/edit/master/_posts/2021-07-10-its-not-always-icache.adoc">
        <i class="fa fa-edit"></i> fix typo
      </a>

      <a href=" /feed.xml">
        <i class="fa fa-rss"></i> rss
      </a>

      <a href="https://github.com/matklad">
        <i class="fa fa-github"></i> matklad
      </a>
    </p>
  </footer>
</body>

</html>
