<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Large Rust Workspaces</title>
  <meta name="description"
    content="In this article, I&#8217;ll share my experience with organizing large Rust projects.This is in no way authoritative&#8201;&#8212;&#8201;just some tips I&#821...">
  <link rel="canonical" href="https://matklad.github.io//2021/08/22/large-rust-workspaces.html">
  <link rel="alternate" type="application/rss+xml" title="matklad" href="https://matklad.github.io//feed.xml">

  <style>
    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Bold.woff2') format('woff2');
      ;
      font-weight: bold;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      margin-block-start: 0;
      margin-block-end: 0;
    }

    h1,
    h2,
    h3 {
      font-weight: 300;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    main {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 80ch;
      padding-left: 2ch;
      padding-right: 2ch;
    }

    .site-header {
      width: 100%;
      max-width: 80ch;
      margin-bottom: 1.5rem;
    }

    .site-header>nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
    }

    .site-header .-title {
      flex-grow: 2;
    }

    .site-footer {
      display: flex;
      justify-content: center;
      align-items: baseline;
      width: 100%;
      max-width: 80ch;
      margin-top: 1rem;
      height: 2rem;
      padding-left: 1ch;
      padding-right: 1ch;
    }
  </style>
  <link rel="stylesheet" href=" /css/adoc.css">
  <link rel="stylesheet" href=" /css/rouge-github.css">
  <link rel="stylesheet" href=" /css/main.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=EB+Garamond:400,400italic,700,700italic%7COpen+Sans:300">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>
  <header class="site-header">
    <nav>
      <a class="-title" href="/">matklad</a>
      
      
      <a href="/about/">About</a>
      
      
      
      
      
      <a href="/resume/">Resume</a>
      
      
      
      
      
      
      
      
      
      
    </nav>
  </header>

  <main>
    <article>
  <h1>Large Rust Workspaces</h1>
  <div class="post-meta sect1">Aug 22, 2021</div>
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this article, I&#8217;ll share my experience with organizing large Rust projects.
This is in no way authoritative&#8201;&#8212;&#8201;just some tips I&#8217;ve discovered through trial and error.</p>
</div>
<div class="paragraph">
<p>Cargo, Rust&#8217;s build system, follows convention over configuration principle.
It provides a set of good defaults for small projects, and it is especially well-tailored for public crates.io libraries.
The defaults are not perfect, but they are good enough.
The resulting ecosystem-wide consistency is also welcome.</p>
</div>
<div class="paragraph">
<p>However, Cargo is less opinionated when it comes to large, multi-crate projects, organized as a Cargo workspace.
Workspaces are flexible&#8201;&#8212;&#8201;Cargo doesn&#8217;t have a preferred layout for them.
As a result, people try different things, with varying degrees of success.</p>
</div>
<div class="paragraph">
<p>To cut to the chase, I think for projects in between ten thousand and one million lines of code, the flat layout makes the most sense.
rust-analyzer (200k lines) is good example here.
The <a href="https://github.com/rust-analyzer/rust-analyzer">repository</a> is laid out this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>rust-analyzer/
  Cargo.toml
  Cargo.lock
  crates/
    rust-analyzer/
    hir/
    hir_def/
    hir_ty/
    ...
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the root of the repo, Cargo.toml defines a virtual manifest:</p>
</div>
<div class="listingblock">
<div class="title">Cargo.toml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="TOML"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>[workspace]
members = ["crates/*"]
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything else (including rust-analyzer &#8220;main&#8221; crate) is nested one-level deep under <code>crates/</code>.
The name of each directory is equal to the name of the crate:</p>
</div>
<div class="listingblock">
<div class="title">crates/hir_def/Cargo.toml</div>
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre>[package]
name = "hir_def"
version = "0.0.0"
edition = "2018"
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>At the time of writing, there are 32 different subfolders in <code>crates/</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="flat-is-better-than-nested"><a class="anchor" href="#flat-is-better-than-nested"></a>Flat Is Better Than Nested</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s interesting that this advice goes against the natural tendency to just organize everything hierarchically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>rust-analyzer/
  Cargo.toml
  src/
  hir/
    Cargo.toml
    src/
    def/
    ty/
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several reasons why trees are inferior in this case.</p>
</div>
<div class="paragraph">
<p><em>First</em>, the Cargo-level namespace of crates is flat.
It&#8217;s not possible to write <code>hir::def</code> in Cargo.toml, so crates typically have prefixes in their names.
Tree layout creates an alternative hierarchy, which adds a possibility for inconsistencies.</p>
</div>
<div class="paragraph">
<p><em>Second</em>, even comparatively large lists are easier to understand at a glance than even small trees.
<code>ls ./crates</code> gives immediate bird&#8217;s eye view of the project, and this view is small enough:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre>16:22:57|~/projects/rust-analyzer|master✓
λ ls ./crates
base_db
cfg
flycheck
hir
hir_def
hir_expand
hir_ty
ide
ide_assists
ide_completion
ide_db
ide_diagnostics
ide_ssr
limit
mbe
parser
paths
proc_macro_api
proc_macro_srv
proc_macro_test
profile
project_model
rust-analyzer
sourcegen
stdx
syntax
test_utils
text_edit
toolchain
tt
vfs
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Doing the same for a tree-based layout is harder.
Looking at a single level doesn&#8217;t tell you which folders contains nested crates.
Looking at <em>all</em> level lists too many folders.
Looking only at folder that contain Cargo.toml gives the right result, but is not as trivial as just <code>ls</code>.</p>
</div>
<div class="paragraph">
<p>It is true that nested structure scales better than a flat one.
But the constant matters&#8201;&#8212;&#8201;until you hit a million lines of code, the number of crates in the project will probably fit on one screen.</p>
</div>
<div class="paragraph">
<p><em>Finally</em>, the last problem with hierarchical layout is that there are no perfect hierarchies.
With a flat structure, adding or splitting the crates is trivial.
With a tree, you need to figure out where to put the new crate, and, if there isn&#8217;t a perfect match for it already, you&#8217;ll have to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add a stupid mostly empty folder near the top</p>
</li>
<li>
<p>add a catch-all utils folder</p>
</li>
<li>
<p>place the code in a known suboptimal directory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a significant issue for long-lived multi-person projects&#8201;&#8212;&#8201;tree structure tends to deteriorate over time, while flat structure doesn&#8217;t need maintenance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="smaller-tips"><a class="anchor" href="#smaller-tips"></a>Smaller Tips</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make the root of the workspace a virtual manifest.
It might be tempting to put the main crate into the root, but that pollutes the root with <code>src/</code>, requires passing <code>--workspace</code> to every Cargo command, and adds an exception to an otherwise consistent structure.</p>
</div>
<div class="paragraph">
<p>Don&#8217;t succumb to the temptation to strip common prefix from folder names.
If each crate is named exactly as the folder it lives in, navigation and renames become easier.
Cargo.tomls of reverse dependencies mention both the folder and the crate name, it&#8217;s useful when they are exactly the same.</p>
</div>
<div class="paragraph">
<p>For large projects a lot of repository bloat often comes from ad-hoc automation&#8201;&#8212;&#8201;Makefiles and various prepare.sh scripts here and there.
To avoid both the bloat and proliferation of ad-hoc workflows, write all automation in Rust in a dedicated crate.
One pattern useful for this is <a href="https://github.com/matklad/cargo-xtask"><code>cargo xtask</code></a>.</p>
</div>
<div class="paragraph">
<p>Use <code>version = "0.0.0"</code> for internal crates you don&#8217;t intend to publish.
If you do want to publish a subset of crates with proper semver API, be very deliberate about them.
It probably makes sense to extract all such crates into a separate top-level folder, <code>libs/</code>.
It makes it easier to check that things in <code>libs/</code> don&#8217;t use things from <code>crates/</code>.</p>
</div>
<div class="paragraph">
<p>Some crates consist only of a single-file.
For those, it is tempting to flatten out the <code>src</code> directory and keep <code>lib.rs</code> and <code>Cargo.toml</code> in the same directory.
I suggest not doing that&#8201;&#8212;&#8201;even if crate is single file now, it might get expanded later.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This post is a part of <a href="https://matklad.github.io/2021/09/05/Rust100k.html">One Hundred Thousand Lines of Rust</a> series.
</td>
</tr>
</table>
</div>
</div>
</div>
</article>

  </main>

  <footer class="site-footer">
    <p>
      <a href="https://github.com/matklad/matklad.github.io/edit/master/_posts/2021-08-22-large-rust-workspaces.adoc">
        <i class="fa fa-edit"></i> fix typo
      </a>

      <a href=" /feed.xml">
        <i class="fa fa-rss"></i> rss
      </a>

      <a href="https://github.com/matklad">
        <i class="fa fa-github"></i> matklad
      </a>
    </p>
  </footer>
</body>

</html>
