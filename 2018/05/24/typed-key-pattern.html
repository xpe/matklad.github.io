<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Typed Key Pattern</title>
  <meta name="description"
    content="In this post, I&#8217;ll talk about a pattern for extracting values from aweakly typed map. This pattern applies to all statically typedlanguages, and even t...">
  <link rel="canonical" href="https://matklad.github.io//2018/05/24/typed-key-pattern.html">
  <link rel="alternate" type="application/rss+xml" title="matklad" href="https://matklad.github.io//feed.xml">

  <style>
    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Bold.woff2') format('woff2');
      ;
      font-weight: bold;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      margin-block-start: 0;
      margin-block-end: 0;
    }

    h1,
    h2,
    h3 {
      font-weight: 300;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    main {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 80ch;
      padding-left: 2ch;
      padding-right: 2ch;
    }

    .site-header {
      width: 100%;
      max-width: 80ch;
      margin-bottom: 1.5rem;
    }

    .site-header>nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
    }

    .site-header .-title {
      flex-grow: 2;
    }

    .site-footer {
      display: flex;
      justify-content: center;
      align-items: baseline;
      width: 100%;
      max-width: 80ch;
      margin-top: 1rem;
      height: 2rem;
      padding-left: 1ch;
      padding-right: 1ch;
    }
  </style>
  <link rel="stylesheet" href=" /css/adoc.css">
  <link rel="stylesheet" href=" /css/rouge-github.css">
  <link rel="stylesheet" href=" /css/main.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=EB+Garamond:400,400italic,700,700italic%7COpen+Sans:300">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>
  <header class="site-header">
    <nav>
      <a class="-title" href="/">matklad</a>
      
      
      <a href="/about/">About</a>
      
      
      
      
      
      <a href="/resume/">Resume</a>
      
      
      
      
      
      
      
      
      
      
    </nav>
  </header>

  <main>
    <article>
  <h1>Typed Key Pattern</h1>
  <div class="post-meta sect1">May 24, 2018</div>
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this post, I&#8217;ll talk about a pattern for extracting values from a
weakly typed map. This pattern applies to all statically typed
languages, and even to dynamically typed ones, but the post is rather
Rust-specific.</p>
</div>
<div class="paragraph">
<p>I&#8217;ve put together a small crate which implements the pattern:<br>
<a href="https://github.com/matklad/typed_key" class="bare">https://github.com/matklad/typed_key</a></p>
</div>
<div class="paragraph">
<p>If you want to skip all the
blah-blah-blah, you can dig right into the code &amp; docs :)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-problem"><a class="anchor" href="#the-problem"></a>The problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have an untyped <code>Map&lt;String, Object&gt;</code> and you need to get a typed
<code>Foo</code> out of it by the <code>"foo"</code> key. The untyped map is often some kind
of configuration, like a JSON file, but it can be a real map with
type-erased <code>Any</code> objects as well.</p>
</div>
<div class="paragraph">
<p>In the common case of statically known configuration, the awesome
solution that Rust offers is <a href="https://crates.io/crates/serde">serde</a>. You stick <code>derive(Deserialize)</code>
in front of the <code>Config</code> struct and read it from JSON, YML, TOML or
even just <a href="https://github.com/softprops/envy">environment variables</a>!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="nd">#[derive(Deserialize)]</span>
<span class="k">struct</span> <span class="n">Config</span> <span class="p">{</span>
    <span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">parse_config</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, occasionally you can&#8217;t use serde. Some of the cases where
this might happen are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>merging configuration from several sources, which requires writing a
non-trivial serde deserializer,</p>
</li>
<li>
<p>lazy deserialization, when you don&#8217;t want to care about invalid values
until you actually use them,</p>
</li>
<li>
<p>extensible plugin architecture, where various independent modules
contribute options to a shared global config, and so the shape of
the config is not known upfront.</p>
</li>
<li>
<p>you are working with <code>Any</code> objects or otherwise don&#8217;t do
serialization per se.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="typical-solutions"><a class="anchor" href="#typical-solutions"></a>Typical solutions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest approach here is to just grab an untyped object using a
string literal and specify its type on the call site:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="k">impl</span> <span class="n">Config</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">get</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Deserialize</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">json_value</span> <span class="o">=</span> <span class="k">self</span><span class="py">.map</span><span class="nf">.get</span><span class="p">(</span><span class="s">"key"</span><span class="p">)</span>
            <span class="nf">.ok_or_else</span><span class="p">(||</span> <span class="nd">bail!</span><span class="p">(</span><span class="s">"key is missing: `{}`"</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="nn">T</span><span class="p">::</span><span class="nf">deserialize</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">...</span>


<span class="k">let</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">config</span><span class="py">.get</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"foo"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>I actually think that this is a fine approach as long as such snippets
are confined within a single module.</p>
</div>
<div class="paragraph">
<p>One possible way to make it better is to extract <code>"foo"</code> constant to a
variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">const</span> <span class="n">FOO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="o">=</span> <span class="s">"foo"</span><span class="p">;</span>

<span class="o">...</span>

<span class="k">let</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">config</span><span class="py">.get</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FOO</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This does bring certain benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fewer places to make a typo in,</p>
</li>
<li>
<p>behavior is moved from the code (<code>.get("foo")</code>) into data (<code>const FOO</code>), which
makes it easier to reason about the code (at a glance, you can see all available
config option and get an idea why they might be useful),</p>
</li>
<li>
<p>there&#8217;s now an obvious place to document keys: write a doc-comment for a
constant.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While great in theory, I personally feel that this usually brings little
tangible benefit in most cases, especially if some constants are used only once.
This is the case where the implementation, a literal <code>"foo"</code>, is more clear than
the abstraction, a constant <code>FOO</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-types"><a class="anchor" href="#adding-types"></a>Adding types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>However, the last pattern can become much more powerful and
interesting if we associate types with string constants. The idea is
to encode that the <code>"foo"</code> key can be used to extract an object of
type <code>Foo</code>, and make it impossible to use it for, say,
<code>Vec&lt;String&gt;</code>. To do this, we&#8217;ll need a pinch of
<a href="https://doc.rust-lang.org/beta/std/marker/struct.PhantomData.html"><code>PhantomData</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">Key</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">marker</span><span class="p">:</span> <span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Key</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">const</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Key</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">Key</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">marker</span><span class="p">:</span> <span class="n">PhantomData</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="nb">str</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.name</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can add type knowledge to the <code>"foo"</code> literal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="k">const</span> <span class="n">FOO</span><span class="p">:</span> <span class="n">Key</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">Key</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"foo"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can take advantage of this in the <code>get</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="k">impl</span> <span class="n">Config</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="n">get</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Deserialize</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">json_value</span> <span class="o">=</span> <span class="k">self</span><span class="py">.map</span><span class="nf">.get</span><span class="p">(</span><span class="n">key</span><span class="nf">.name</span><span class="p">())</span>
            <span class="nf">.ok_or_else</span><span class="p">(||</span> <span class="nd">bail!</span><span class="p">(</span><span class="s">"key is missing: `{}`"</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="nn">T</span><span class="p">::</span><span class="nf">deserialize</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">...</span>


<span class="k">let</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">config</span><span class="nf">.get</span><span class="p">(</span><span class="n">FOO</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how we were able to get rid of the turbofish at the call-site!
Moreover, the understandably aspect of the previous pattern is also
enhanced: if you know both the type and the name of the config option,
you can pretty reliably predict how it is going to be used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pattern-in-the-wild"><a class="anchor" href="#pattern-in-the-wild"></a>Pattern in the wild</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve first encountered this pattern in <a href="https://github.com/JetBrains/intellij-community/blob/16bfca92199dca383b66c69c3427b4639ea8e213/platform/util/src/com/intellij/openapi/util/Key.java">IntelliJ</a> code. It uses
<a href="https://github.com/JetBrains/intellij-community/blob/16bfca92199dca383b66c69c3427b4639ea8e213/platform/util/src/com/intellij/openapi/util/UserDataHolder.java"><code>UserDataHolder</code></a>, which is basically <code>Map&lt;String, Object&gt;</code>, everywhere.
It helps plugin authors to extend built-in objects in crazy ways but is rather
hard to reason about, and type-safety improves the situation a lot. I&#8217;ve also
changed Exonum&#8217;s config to employ this pattern in this <a href="https://github.com/exonum/exonum/pull/417">PR</a>. It also was a
case of plugin extensible, where an upfront definition of all configuration
option is impossible.</p>
</div>
<div class="paragraph">
<p>Finally, I&#8217;ve written a small crate for this <a href="https://crates.io/crates/typed_key"><code>typed_key</code></a> :)</p>
</div>
<div class="paragraph">
<p>Discussion on <a href="https://www.reddit.com/r/rust/comments/8ls25e/blog_post_typed_key_pattern/">/r/rust</a>.</p>
</div>
</div>
</div>
</article>

  </main>

  <footer class="site-footer">
    <p>
      <a href="https://github.com/matklad/matklad.github.io/edit/master/_posts/2018-05-24-typed-key-pattern.adoc">
        <i class="fa fa-edit"></i> fix typo
      </a>

      <a href=" /feed.xml">
        <i class="fa fa-rss"></i> rss
      </a>

      <a href="https://github.com/matklad">
        <i class="fa fa-github"></i> matklad
      </a>
    </p>
  </footer>
</body>

</html>
